<html>

<head>
    <title>CS318 - Software Engineering 1 - AY 2023-2024 - 1st Semester</title>
</head>
<style>
    body {
        font-family: Arial;
    }

    #main {
        width: 50%;
        margin: 0 auto;
        padding: 20px;
        border-radius: 10px;
        background-color: #ccc;
    }

    #message,
    #modal-message {
        color: #000;
        background-color: #fff;
        padding: 10px;
        margin-bottom: 5px;
        border-radius: 5px;
    }

    .app-title,
    .modal-title {
        background-color: #fff;
        padding: 10px;
        border-radius: 5px;
        margin-top: 0;
        margin-bottom: 5px;
        text-align: center;
    }

    .success {
        color: #fff !important;
        background-color: green !important;
    }

    .error {
        color: #fff !important;
        background-color: red !important;
    }

    .hidden {
        display: none !important;
    }

    .input-group {
        margin-bottom: 5px;
    }

    .input-group.action-buttons {
        text-align: center;
    }

    .input-group > label {
        display: block;
        width: 100%;
    }

    .field-label,
    .field-value {
        height: 35px;
        padding: 5px;
    }

    .field-label {
        font-weight: bold;
    }

    .field-value.text-area {
        height: 105px;
    }

    .input-group .field-label {
        width: 15%;
        text-align: right;
        border-right: solid thin #000;
    }

    .input-group .field-value {
        width: 80%;
    }

    .input-group .field-value > input[type="text"],
    .input-group .field-value > input[type="email"] {
        width: 100%;
    }

    input[type="text"],
    input[type="email"],
    input[type="password"] {
        padding: 5px;
        border: none;
        width: 250px;
        font-weight: bold;
    }

    textarea {
        width: 100%;
        height: 100px;
        border: 0;
    }

    button {
        font-weight: bold;
    }

    table.striped-table {
        width: 100%;
        padding: 5px;
        border-radius: 5px;
        background-color: #000;
        color: #fff;
    }

    table.striped-table tr:nth-child(even) {
        background-color: #fff;
        color: #000;
    }

    table.striped-table td {
        padding: 5px;
        height: 30px;
    }

    table.striped-table tr:hover {
        background-color: #ccc;
        color: #000;
        font-weight: bold;
        cursor: pointer;
    }

    #data-table {
        text-align: center;
    }

    .close-button {
        position: relative;
        top: 0;
        display: block;
        width: 10px;
        height: 10px;
        border-radius: 10px;
        padding: 5px;
        text-align: center;
        font-size: 9px;
        font-weight: bold;
        background: #000;
        color: #fff;
    }

    .close-button:hover {
        cursor: pointer;
    }

    .left {
        float: left;
    }

    .right {
        float: right;
    }

    .footer {
        font-size: 12px;
        padding: 5px;
        margin-bottom: 5px;
    }

    .dark-bg {
        position: absolute;
        background-color: #000;
        opacity: 0.75;
        top: 0;
        left: 0;
        height: 100vh;
        width: 100vw;
    }

    .faq-button,
    .contact-us-button {
        font-weight: bold;
    }

    .faq-button:hover,
    .contact-us-button:hover {
        cursor: pointer;
        text-decoration: underline;
    }

    .faq-modal,
    .contact-us-modal {
        z-index: 9999;
        position: relative;
        margin: 0 auto;
        width: 50%;
        background-color: #fff;
        opacity: 1;
        border-radius: 20px;
        padding: 10px;
        top: -5%;
    }

    .faq-modal > h4 {
        padding: 5px;
        border: solid thin #fff;
        margin-bottom: 0;
    }

    .faq-modal > h4:hover {
        border: solid thin #000;
        cursor: pointer;
    }

    .faq-modal > p {
        padding: 10px;
        text-align: justify;
        margin-top: 0;
    }

    .contact-us-modal > .close-button,
    .faq-modal > .close-button {
        position: absolute;
        top: 3%;
        right: 2%;
    }
</style>

<body>
    <div id="main">
        <h3 class="app-title">CS318 - Software Engineering 1 - AY 2023-2024 - 1st Semester</h3>
        <div class="input-group">
            <input type="text" id="txtSID" placeholder="Enter student ID (e.g. 17-00410)" />
        </div>
        <div class="input-group">
            <input type="password" id="txtCODE" placeholder="Enter code" /> <span style="font-size: 10pt;"><b>No code
                    yet?</b></span> <button id="btnGETCODE">Get
                code here</button>
        </div>
        <div class="input-group">
            <button id="btnVIEWGRADES">View Grades</button>
        </div>
        <div class="footer">
            <div class="left"></div>
            <div class="right">
                <span class="faq-button">FAQ</span> | <span class="contact-us-button">Contact Us</span>
            </div>
            <div style="clear:both;"></div>
        </div>
        <div id="message" class="hidden">
            <span class="close-button right">x</span>
            <span class="message-content">&nbsp;</span>
        </div>
        <div id="data-table" class="hidden">&nbsp;</div>
    </div>
    <div class="dark-bg hidden">&nbsp;</div>
    <div class="faq-modal hidden">
        <h2 class="modal-title">Frequently Asked Questions (FAQ)</h2>
        <span class="close-button">x</span>
        <h4>How do I see my grades?</h4>
        <p class="hidden">Enter your Student ID and the unique code that was sent to your email. Click <b>View Grades</b> button to see your
            grades.</p>
        <h4>How do I get my unique code?</h4>
        <p class="hidden">Supply your Student ID and then click <b>Get code here</b> button. You will receive an email containing the code
            and the link to this page.</p>
        <h4>I cannot get my code because of missing email address. What should I do?</h4>
        <p class="hidden">Please contact the administrator and submit your email address. Please wait for the advise for you to try
            again.</p>
        <h4>I have provided my Student ID and the the unique code, but nothing happened.</h4>
        <p class="hidden">Please contact the administrator and report your concern.</p>
        <h4>How do I contact the administrator?</h4>
        <p class="hidden">Click <b>Contact Us</b> found on the lower right corner of the app box. Supply the necessary fields, and
            click <b>Submit</b> button. An email will be sent to the administrator containing your concern.</p>
    </div>
    <div class="contact-us-modal hidden">
        <h2 class="modal-title">Contact Us</h2>
        <span class="close-button">x</span>
        <div class="input-group">
            <label>
                <div class="field-label left">Name</div>
                <div class="field-value left"><input id="txtSenderName" type="text" placeholder="e.g., John Doe" /></div>
                <div style="clear:both;"></div>
            </label>
        </div>
        <div class="input-group">
            <label>
                <div class="field-label left">Email <span>*</span></div>
                <div class="field-value left"><input id="txtSenderEmail" type="email" placeholder="e.g., john.doe@fakeemail.com" /></div>
                <div style="clear:both;"></div>
            </label>
        </div>
        <div class="input-group">
            <label>
                <div class="field-label left">Subject <span>*</span></div>
                <div class="field-value left"><input id="txtSubject" type="text" placeholder="e.g., Missing email issue" /></div>
                <div style="clear:both;"></div>
            </label>
        </div>
        <div class="input-group">
            <label>
                <div class="field-label left">Message <span>*</span></div>
                <div class="field-value text-area left"><textarea id="txtMessage" placeholder="e.g., Requesting to update my email to john.doe@fakeemail.com. Thanks."></textarea></div>
                <div style="clear:both;"></div>
            </label>
        </div>
        <div class="input-group action-buttons">
            <button id="btnSubmitMessage">Submit</button>
            <button id="btnResetContactUsForm">Reset</button>
        </div>
        <div id="modal-message" class="hidden">
            <span class="close-button right">x</span>
            <span class="modal-message-content">&nbsp;</span>
        </div>
    </div>
</body>
<script src="https://ncfjourney-eb3b.restdb.io/rest/_jsapi.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"
    integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<script>
    var apiUrl = "https://ncfjourney-eb3b.restdb.io/";
    var apiKey = "64ffc3426888540e5e0bff4c";
    var ajaxSettings = {
        "async": true,
        "crossDomain": true,
        "headers": {
            "x-apikey": apiKey,
            "content-type": "application/json",
            "cache-control": "no-cache",
        },
        "processData": false,
    };
    var loaderImage = '<img src="images/loading-12.gif" width="10%" />';
    $(function () {
        var originalBodyHeight = parseFloat($('body').css('height').replace('px', ''));
        $('.faq-modal > h4').on('click', function () {
            var $this = $(this);
            $this.next('p').slideDown().removeClass('hidden').siblings('p').slideUp();
        })

        function clearMessage() {
            $('#message').removeClass('success error').fadeOut().children('.message-content').html('');
        }

        function clearModalMessage() {
            $('#modal-message').removeClass('success error').fadeOut().children('.modal-message-content').html('');
        }

        function resetContactUsForm() {
            var fields = $('.contact-us-modal input');
            $.each(fields, function (i, field) {
                $(field).val('');
            });
            $('.contact-us-modal textarea').val('');
        }

        $('#txtSID').focus();

        $('#message > .close-button').on('click', function () {
            var $this = $(this);
            clearMessage();
        });

        $('#modal-message > .close-button').on('click', function () {
            var $this = $(this);
            clearModalMessage();
        });

        $('.contact-us-modal > .close-button').on('click', function () {
            $('.dark-bg').click();
        });

        $('.faq-modal > .close-button').on('click', function () {
            $('.dark-bg').click();
        });

        $('.dark-bg').on('click', function () {
            $('.dark-bg').fadeOut();
            $('.faq-modal').fadeOut();
            $('.contact-us-modal').fadeOut();
            if ($('body').css('height') > originalBodyHeight) {
                $('body').css('overflow', 'scroll');
            }
        });

        $('.faq-button').on('click', function () {
            if ($('#data-table').html() != '&nbsp;') {
                $('.faq-modal').css({'top': '-65%'});
            } else {
                $('.faq-modal').css({'top': '-5%'});
            }
            $('.dark-bg').fadeIn().removeClass('hidden');
            $('.faq-modal').fadeIn().removeClass('hidden');
            $('body').css('overflow', 'hidden');
        });


        $('.contact-us-button').on('click', function () {
            if ($('#data-table').html() != '&nbsp;') {
                $('.contact-us-modal').css({'top': '-65%'});
            } else {
                $('.contact-us-modal').css({'top': '-5%'});
            }
            $('.dark-bg').fadeIn().removeClass('hidden');
            $('.contact-us-modal').fadeIn().removeClass('hidden');
            $('body').css('overflow', 'hidden');
        });

        $('#txtSID').on('keyup paste', function () {
            $('#btnGETCODE').removeAttr('disabled');
            $('#btnVIEWGRADES').removeAttr('disabled');
        });

        $('#txtCODE').on('keyup paste', function () {
            $('#btnVIEWGRADES').removeAttr('disabled');
        });

        $('#btnGETCODE').on('click', function () {
            var $this = $(this);
            $this.attr('disabled', 'disabled');
            $('#btnVIEWGRADES').attr('disabled', 'disabled');
            var db = new restdb(apiKey);
            var sid = $('#txtSID').val();
            if (!sid.length) {
                $('#message').removeClass('hidden success').addClass('error').show().children('.message-content').html('Student ID required!');
                $('#txtSID').focus();
                $this.removeAttr('disabled');
                return;
            }
            clearMessage();
            var query = { 'student_id': sid };
            var hints = { "$max": 1, "$fields": { "_id": 1, "student_id": 1, "student_name": 1, "email": 1, "code": 1, "code_sent": 1 } };
            db.cs318ay2324sem1.find(query, hints, function (err, res) {
                if (!err) {
                    if (!res.length) {
                        $('#message').removeClass('hidden success').addClass('error').show().children('.message-content').html('Failed to retrieve student record!');
                        $this.removeAttr('disabled');
                        return;
                    }
                    var student = res[0];
                    if (!student.email.length) {
                        $('#message').removeClass('hidden success').addClass('error').show().children('.message-content').html('Missing email address!');
                        $this.removeAttr('disabled');
                        return;
                    }
                    if (!student.code.length) {
                        $('#message').removeClass('hidden success').addClass('error').show().children('.message-content').html('Missing code!');
                        $this.removeAttr('disabled');
                        return;
                    }
                    if (student.code_sent == 1) {
                        var conf = confirm("Code has already been sent. Resend?");
                        if (!conf) {
                            $('#message').removeClass('hidden success').addClass('error').show().children('.message-content').html('Code has already been sent!');
                            $this.removeAttr('disabled');
                            return;
                        }
                    }
                    var subject = '[Code Request] CS318 - Software Engineering 1 - AY 2023-2024 - 1st Semester';
                    var firstName = student.student_name.split(",")[1].trim().split(" ")[0];
                    var body = 'Hi <b>' + firstName + '</b>!<p>Here is you unique code: <b>' + student.code + '</b><br>Go to: <a href="https://mythtergithub.github.io/grade-viewer/">https://mythtergithub.github.io/grade-viewer/</a></p><p>Cheers,<br>Sir John</p>';
                    var emailProperties = { 'subject': subject, 'html': body, 'to': student.email, 'company': 'NCF-CCS Solutions', 'sendername': "John Ryan Lorca" };
                    ajaxSettings.method = "POST";
                    ajaxSettings.url = apiUrl + "mail";
                    ajaxSettings.data = JSON.stringify(emailProperties);
                    $.ajax(ajaxSettings)
                        .done(function (response) {
                            $('#message').removeClass('hidden error').addClass('success').show().children('.message-content').html('Unique code sent! Please check your email.');
                            ajaxSettings.method = "PUT";
                            ajaxSettings.url = apiUrl + "rest/cs318ay2324sem1/" + student._id;
                            student.code_sent = 1;
                            delete student._id;
                            delete student.email;
                            delete student.code;
                            ajaxSettings.data = JSON.stringify(student);
                            $.ajax(ajaxSettings);
                        }).fail(function (response) {
                            console.log(response);
                            $('#message').removeClass('hidden success').addClass('error').show().html('Something went wrong! Please contact your administrator.');
                            $this.removeAttr('disabled');
                        });
                } else {
                    $this.removeAttr('disabled');
                }
            });
        });

        $('#btnVIEWGRADES').on('click', function () {
            clearMessage();
            var $this = $(this);
            $this.attr('disabled', 'disabled');
            $('#btnGETCODE').attr('disabled', 'disabled');
            $('#data-table').removeClass('hidden').show().html(loaderImage);
            var db = new restdb(apiKey);
            var sid = $('#txtSID').val();
            var code = $('#txtCODE').val();
            if (!sid.length || !code.length) {
                $('#data-table').addClass('hidden').html('');
                $('#message').removeClass('hidden success').addClass('error').show().children('.message-content').html('Student ID and Code required!');
                $('#txtSID').focus();
                $this.removeAttr('disabled');
                $('#btnGETCODE').removeAttr('disabled');
                return;
            }
            var query = { 'student_id': sid, 'code': code };
            var fields = {
                "student_id": 1, "student_name": 1, "email": 1,
                "prelims_ng": 1, "prelims_ug": 1,
                "midterms_ng": 1, "midterms_ug": 1,
                "prefinals_ng": 1, "prefinals_ug": 1,
                "finals_ng": 1, "finals_ug": 1,
            };
            var hints = { "$max": 1, "$fields": fields };
            db.cs318ay2324sem1.find(query, hints, function (err, res) {
                console.log(res);
                if (!err) {
                    $('#data-table').addClass('hidden').html('');
                    $('#txtCODE').val('');
                    if (!res.length) {
                        $('#message').removeClass('hidden success').addClass('error').show().children('.message-content').html('Failed to retrieve info!');
                        $('#txtSID').focus();
                        $this.removeAttr('disabled');
                        $('#btnGETCODE').removeAttr('disabled');
                        return;
                    }
                    var student = res[0];
                    student.prelims_ng = +student.prelims_ng.toFixed(2);
                    student.prelims_ug = +student.prelims_ug.toFixed(2);
                    student.midterms_ng = +student.midterms_ng.toFixed(2);
                    student.midterms_ug = +student.midterms_ug.toFixed(2);
                    student.prefinals_ng = +student.prefinals_ng.toFixed(2);
                    student.prefinals_ug = +student.prefinals_ug.toFixed(2);
                    student.finals_ng = +student.finals_ng.toFixed(2);
                    student.finals_ug = +student.finals_ug.toFixed(2);
                    student.midterms_avg = (student.prelims_ng + student.midterms_ng) / 2;
                    student.midterms_avg = +student.midterms_avg.toFixed(2);
                    student.prefinals_avg = (student.prelims_ng + student.midterms_ng + student.prefinals_ng) / 3;
                    student.prefinals_avg = +student.prefinals_avg.toFixed(2);
                    student.finals_avg = (student.prelims_ng + student.midterms_ng + student.prefinals_ng + student.finals_ng) / 4;
                    student.finals_avg = +student.finals_avg.toFixed(2)
                    fields.midterms_avg = 1;
                    fields.prefinals_avg = 1;
                    fields.finals_avg = 1;
                    var keys = Object.keys(fields);
                    $('#message').removeClass('hidden error').addClass('success').show().children('.message-content').html('Record found!');
                    var table = $('<table class="striped-table"></table>');
                    for (i in keys) {
                        var row = $('<tr></tr>');
                        fieldName = keys[i];
                        label = keys[i].toUpperCase();
                        row.append($('<td width="30%">' + label + '</td><td> ' + student[keys[i]] + ' </td>'));
                        table.append(row);
                    }
                    table.append(row);
                    $('#data-table').removeClass('hidden').show().append(table);
                } else {
                    $this.removeAttr('disabled');
                }
            });
        });
        
        $('#txtSenderEmail, #txtSubject, #txtMessage').on('keypress', function () {
            $(this).css({'border': 'none'});
        });

        $('#btnSubmitMessage').on('click', function () {
            var $this = $(this);
            $this.attr('disabled', 'disabled');
            var db = new restdb(apiKey);
            var senderName = $('#txtSenderName').val();
            var senderEmail = $('#txtSenderEmail').val();
            var subject = $('#txtSubject').val();
            var message = $('#txtMessage').val();
            if (!senderEmail.length || !subject.length || !message.length) {
                $('#modal-message').addClass('error').removeClass('hidden').show().children('.modal-message-content').html('Missing required fields!');
                $('#txtSenderEmail').css({'border': 'solid thin red'});
                $('#txtSubject').css({'border': 'solid thin red'});
                $('#txtMessage').css({'border': 'solid thin red'});
                $this.removeAttr('disabled');
                return
            }
            var emailSettings = { "from_name": senderName, "from": senderEmail, "subject": subject, "body": message };
            var newMessage = new db.emailinbound(emailSettings);
            newMessage.save(function (err, res) {
                if (!err) {
                    $('#modal-message').addClass('success').removeClass('hidden').show().children('.modal-message-content').html('Message succesfully sent!');
                } else {
                    $('#modal-message').addClass('error').removeClass('hidden').show().children('.modal-message-content').html('Something went wrong!');
                    $this.removeAttr('disabled');
                }
            });
        });

        $('#btnResetContactUsForm').on('click', function () {
            resetContactUsForm();
        });
    });
</script>

</html>